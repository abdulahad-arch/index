<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart AgriAdvisor</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f7;color:#222}
  header{background:#2b6cb0;color:white;padding:18px 14px;text-align:center;font-size:20px;font-weight:700}
  .container{padding:14px;max-width:720px;margin:0 auto}
  .card{background:white;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:12px}
  label{display:block;font-weight:600;margin-bottom:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#2b6cb0;color:white;border:none;padding:10px 12px;border-radius:6px;cursor:pointer}
  button.secondary{background:#38a169}
  button.gray{background:#718096}
  select,input{padding:8px;border:1px solid #ddd;border-radius:6px;width:100%}
  .result{color:#c53030;font-weight:700;margin-top:8px}
  .small{font-size:13px;color:#666}
  pre {background:#0f1724;color:#e6eef8;padding:8px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
<header>Smart AgriAdvisor</header>
<div class="container">

  <!-- Wi-Fi -->
  <div class="card">
    <label>ESP32 Wi-Fi</label>
    <div class="row">
      <input id="espIp" value="192.168.4.1"/>
      <button id="btnConnect">Connect</button>
      <button id="btnDisconnect" class="gray">Disconnect</button>
    </div>
    <span id="loadMsg" class="small"></span>
  </div>

  <!-- Soil -->
  <div class="card">
    <label>Soil Readings</label>
    <div id="lblPH">pH: --</div>
    <div id="lblMoist">Moisture: --</div>
    <div id="lblTemp">Temp: --</div>
    <div class="row">
      <button id="btnTakeReading">Take Soil Reading</button>
      <button id="btnRefresh" class="secondary">Refresh</button>
    </div>
    <div id="logArea" class="small"></div>
  </div>

  <!-- Crops -->
  <div class="card">
    <label>Crop Selection</label>
    <select id="cropSelect"></select>
    <button id="btnCheck">Check Suitability</button>
    <button id="btnAI" class="secondary">AI Suggest</button>
    <div id="lblResult" class="result"></div>
  </div>

  <!-- Robot Controls -->
  <div class="card">
    <label>Robot Controls</label>
    <div class="row">
      <button data-act="forward">‚¨Ü Forward</button>
      <button data-act="left">‚¨Ö Left</button>
      <button data-act="stop">üõë Stop</button>
      <button data-act="right">‚û° Right</button>
      <button data-act="backward">‚¨á Backward</button>
      <button data-act="servoDip">‚öôÔ∏è Dip Servo</button>
      <button data-act="servoLift">‚öôÔ∏è Lift Servo</button>
    </div>
  </div>

  <!-- Translator -->
  <div class="card">
    <label>Translator</label>
    <input id="txtTranslate" placeholder="Enter text"/>
    <select id="langSelect">
      <option value="hi">Hindi</option>
      <option value="te">Telugu</option>
    </select>
    <button id="btnTranslate">Translate</button>
    <div id="lblTranslation"></div>
  </div>

  <!-- Weather -->
  <div class="card">
    <label>Weather Advisory</label>
    <input id="city" placeholder="Enter city"/>
    <button id="btnWeather">Check Weather</button>
    <div id="lblWeather"></div>
  </div>

  <!-- Profit Estimator -->
  <div class="card">
    <label>Profit Estimator</label>
    <input id="yield" placeholder="Yield in quintals"/>
    <button id="btnProfit">Estimate Profit</button>
    <div id="lblProfit"></div>
  </div>

  <!-- Debug -->
  <div class="card">
    <label>Debug</label>
    <pre id="debug">No data yet</pre>
  </div>

</div>

<script>
/* --- Crops DB (50 crops with price Rs/quintal) --- */
let cropDB=[
  ["Wheat",6,7.5,40,15,2000],["Rice",5.5,7,60,20,1800],["Maize",5.5,7,50,18,1500],
  ["Cotton",6,8,50,22,5000],["Potato",5.5,7,30,15,1200],["Tomato",5.5,7,30,20,1500],
  ["Onion",6,7,35,18,1400],["Sugarcane",6,8,60,21,3000],["Soybean",6,7.5,40,20,2500],
  ["Peanut",5.5,7,35,22,3000],["Sunflower",6,7.5,30,18,3200],["Barley",6,7.5,35,15,1600],
  ["Oats",5,7.5,35,15,1800],["Millet",5,7.5,30,20,1400],["Sorghum",5.5,7.5,35,22,1600],
  ["Chickpea",6,8,30,18,4000],["Lentil",6,8,30,16,4500],["Pea",6,7.5,35,15,2800],
  ["Mustard",5.5,7.5,30,18,5000],["Groundnut",5.5,7.5,35,22,3500],["Sesame",5.5,7.5,30,20,6000],
  ["Castor",5.5,7.5,30,20,4000],["Jute",6,7.5,50,20,2500],["Tea",4.5,6,60,18,12000],
  ["Coffee",5,6.5,60,20,15000],["Banana",5.5,7.5,50,22,1000],["Mango",5.5,7.5,30,25,3000],
  ["Apple",6,7,40,15,5000],["Orange",5.5,6.5,40,20,4000],["Grapes",6,7.5,35,20,4500],
  ["Papaya",6,7.5,40,22,2000],["Guava",5,7.5,35,20,2500],["Pineapple",4.5,6.5,50,22,3000],
  ["Pomegranate",5.5,7.5,35,20,5000],["Cabbage",6,7.5,40,15,1200],["Cauliflower",6,7.5,40,15,1400],
  ["Carrot",6,7,35,15,2000],["Spinach",6,7.5,35,15,1000],["Cucumber",5.5,7.5,40,18,1500],
  ["Chilli",5.5,7.5,40,20,6000],["Brinjal",5.5,7.5,40,20,2000],["Okra",6,7.5,40,20,2500],
  ["Pumpkin",6,7.5,40,18,1500],["Melon",5.5,7.5,35,20,2000],["Watermelon",5.5,7.5,35,22,1800],
  ["Strawberry",5.5,7,40,18,8000],["Pear",6,7,35,15,3500],["Plum",6,7.5,35,15,3000]
];
let phVal=0, moistVal=0, tempVal=0;

/* --- Wi-Fi --- */
let espUrl="", espConnected=false;
function setStatus(t){document.getElementById('loadMsg').innerText=t;}

document.getElementById("btnConnect").onclick=async()=>{
  espUrl="http://"+document.getElementById("espIp").value;
  try{
    let r=await fetch(espUrl+"/");
    if(r.ok){espConnected=true;alert("‚úÖ ESP32 Connected!");setStatus("Connected to "+espUrl);}
    else{throw new Error("Not OK");}
  }catch(e){espConnected=false;alert("‚ùå ESP32 Not Connected");setStatus("Failed to connect");}
};

document.getElementById("btnDisconnect").onclick=()=>{espConnected=false;setStatus("Disconnected");};

async function callEsp(path){
  if(!espConnected)return;
  try{
    const r=await fetch(espUrl+path);
    const txt=await r.text();
    document.getElementById("debug").innerText=txt;
    return txt;
  }catch(e){document.getElementById("debug").innerText="Error: "+e;}
}

/* --- Soil --- */
async function readSoil(){
  let txt=await callEsp("/readSensors");
  if(txt){
    let n=txt.match(/-?\d+(\.\d+)?/g);
    if(n){phVal=n[0];moistVal=n[1];tempVal=n[2];}
    document.getElementById("lblPH").innerText="pH: "+phVal;
    document.getElementById("lblMoist").innerText="Moisture: "+moistVal;
    document.getElementById("lblTemp").innerText="Temp: "+tempVal;
    let logs=JSON.parse(localStorage.getItem("soilLogs")||"[]");
    logs.push({ph:phVal,moist:moistVal,temp:tempVal,time:new Date().toLocaleString()});
    localStorage.setItem("soilLogs",JSON.stringify(logs));
    document.getElementById("logArea").innerText="Last 3 logs:\n"+logs.slice(-3).map(l=>`${l.time} ‚Üí pH:${l.ph}, M:${l.moist}, T:${l.temp}`).join("\n");
  }
}
document.getElementById("btnTakeReading").onclick=readSoil;
document.getElementById("btnRefresh").onclick=readSoil;

/* --- Crops --- */
function populate(){let s=document.getElementById("cropSelect");cropDB.forEach(r=>{let o=document.createElement("option");o.value=r[0];o.text=r[0];s.appendChild(o);});}
populate();
document.getElementById("btnCheck").onclick=()=>{
  let crop=document.getElementById("cropSelect").value;
  let r=cropDB.find(x=>x[0]==crop);
  if(r){let ok=phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4];
    document.getElementById("lblResult").innerText=ok?"‚úÖ Suitable":"‚ùå Not Suitable";}
};
document.getElementById("btnAI").onclick=()=>{
  let list=cropDB.filter(r=>phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4]);
  document.getElementById("lblResult").innerText=list.length? "AI Suggests: "+list.map(x=>x[0]).join(", "):"No suitable crop";
};

/* --- Robot Controls --- */
document.querySelectorAll("button[data-act]").forEach(b=>{
  b.onclick=()=>callEsp("/"+b.dataset.act);
});

/* --- Translator --- */
document.getElementById("btnTranslate").onclick=async()=>{
  let txt=document.getElementById("txtTranslate").value;
  let lang=document.getElementById("langSelect").value;
  let url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=en|${lang}`;
  let r=await fetch(url); let j=await r.json();
  document.getElementById("lblTranslation").innerText=j.responseData.translatedText;
};

/* --- Weather --- */
document.getElementById("btnWeather").onclick=async()=>{
  let city=document.getElementById("city").value;
  if(!city)return;
  try{
    let r=await fetch(`https://wttr.in/${city}?format=%t+%h+%w`);
    let t=await r.text();
    document.getElementById("lblWeather").innerText="Weather: "+t+"\nAdvice: Irrigate only if humidity < 40%";
  }catch(e){document.getElementById("lblWeather").innerText="Error: "+e;}
};

/* --- Profit Estimator --- */
document.getElementById("btnProfit").onclick=()=>{
  let crop=document.getElementById("cropSelect").value;
  let y=parseFloat(document.getElementById("yield").value||0);
  let r=cropDB.find(x=>x[0]==crop);
  if(r){
    let price=r[5]; let profit=y*price;
    document.getElementById("lblProfit").innerText=`Profit for ${crop}: ‚Çπ${profit.toLocaleString()}`;
  }
};
</script>
</body>
</html>
