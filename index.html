<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart AgriAdvisor</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f7;color:#222}
  header{background:#2b6cb0;color:white;padding:18px 14px;text-align:center;font-size:20px;font-weight:700}
  .container{padding:14px;max-width:720px;margin:0 auto}
  .card{background:white;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:12px}
  label{display:block;font-weight:600;margin-bottom:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#2b6cb0;color:white;border:none;padding:10px 12px;border-radius:6px;cursor:pointer}
  button.secondary{background:#38a169}
  button.gray{background:#718096}
  select,input{padding:8px;border:1px solid #ddd;border-radius:6px;width:100%}
  .status{font-weight:700;margin-top:6px}
  .result{color:#c53030;font-weight:700;margin-top:8px}
  .small{font-size:13px;color:#666}
  .controls .btn{flex:1;min-width:110px}
  pre {background:#0f1724;color:#e6eef8;padding:8px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
<header>Smart AgriAdvisor</header>
<div class="container">

  <!-- Wi-Fi -->
  <div class="card">
    <label>ESP32 Wi-Fi</label>
    <div class="row">
      <input id="espIp" value="192.168.4.1"/>
      <button id="btnConnect">Connect</button>
      <button id="btnDisconnect" class="gray">Disconnect</button>
    </div>
    <span id="loadMsg" class="small"></span>
  </div>

  <!-- Bluetooth -->
  <div class="card">
    <label>ESP32 Bluetooth</label>
    <button id="btnBTScan">üîç Scan Devices</button>
    <select id="btDevices"></select>
    <button id="btnBTConnect">üîó Connect</button>
    <button id="btnBTDisconnect" class="gray">Disconnect</button>
    <div id="btStatus" class="small">BT: Not connected</div>
  </div>

  <!-- Soil -->
  <div class="card">
    <label>Soil Readings</label>
    <div id="lblPH">pH: --</div>
    <div id="lblMoist">Moisture: --</div>
    <div id="lblTemp">Temp: --</div>
    <button id="btnTakeReading">Take Soil Reading</button>
  </div>

  <!-- Crops -->
  <div class="card">
    <label>Crop Selection</label>
    <select id="cropSelect"></select>
    <button id="btnCheck">Check Suitability</button>
    <button id="btnAI" class="secondary">AI Suggest</button>
    <div id="lblResult" class="result"></div>
  </div>

  <!-- Translator -->
  <div class="card">
    <label>Translator</label>
    <input id="txtTranslate" placeholder="Enter text"/>
    <select id="langSelect">
      <option value="hi">Hindi</option>
      <option value="te">Telugu</option>
    </select>
    <button id="btnTranslate">Translate</button>
    <div id="lblTranslation"></div>
  </div>

  <!-- Voice Assistant -->
  <div class="card">
    <label>Voice Assistant</label>
    <button id="btnVoice">üé§ Speak</button>
    <div id="lblVoice"></div>
  </div>

  <!-- Debug -->
  <div class="card">
    <label>Debug</label>
    <pre id="debug">No data yet</pre>
  </div>

</div>

<script>
/* --- Dummy Crops DB --- */
let cropDB=[["Wheat",6,7.5,40,15],["Rice",5.5,7,60,20],["Maize",5.5,7,50,18]];
let phVal=0, moistVal=0, tempVal=0;

/* --- Wi-Fi --- */
let espUrl="", espConnected=false;
function setStatus(t){document.getElementById('loadMsg').innerText=t;}
document.getElementById("btnConnect").onclick=()=>{
  espUrl="http://"+document.getElementById("espIp").value;
  espConnected=true; setStatus("Connected to "+espUrl);
};
document.getElementById("btnDisconnect").onclick=()=>{espConnected=false;setStatus("Disconnected");};
async function callEsp(path){
  if(!espConnected)return;
  const r=await fetch(espUrl+path); const txt=await r.text();
  document.getElementById("debug").innerText=txt; return txt;
}

/* --- Bluetooth --- (Cordova plugin only) */
let btDevice=null;
document.getElementById("btnBTScan").onclick=()=>{
  if(window.bluetoothSerial){
    bluetoothSerial.list(devices=>{
      let sel=document.getElementById("btDevices"); sel.innerHTML="";
      devices.forEach(d=>{
        let o=document.createElement("option"); o.value=d.address; o.text=d.name; sel.appendChild(o);
      });
    },err=>alert("BT Scan error:"+err));
  }else alert("BT only works in APK build.");
};
document.getElementById("btnBTConnect").onclick=()=>{
  let addr=document.getElementById("btDevices").value;
  if(window.bluetoothSerial){
    bluetoothSerial.connect(addr,()=>{document.getElementById("btStatus").innerText="BT: Connected";},()=>alert("BT connect fail"));
  }
};
document.getElementById("btnBTDisconnect").onclick=()=>{
  if(window.bluetoothSerial) bluetoothSerial.disconnect(()=>{document.getElementById("btStatus").innerText="BT: Disconnected";});
};

/* --- Soil --- */
document.getElementById("btnTakeReading").onclick=async()=>{
  let txt=await callEsp("/readSensors");
  if(txt){
    let n=txt.match(/-?\d+(\.\d+)?/g);
    if(n){phVal=n[0];moistVal=n[1];tempVal=n[2];}
    document.getElementById("lblPH").innerText="pH: "+phVal;
    document.getElementById("lblMoist").innerText="Moisture: "+moistVal;
    document.getElementById("lblTemp").innerText="Temp: "+tempVal;
  }
};

/* --- Crops --- */
function populate(){let s=document.getElementById("cropSelect");cropDB.forEach(r=>{let o=document.createElement("option");o.value=r[0];o.text=r[0];s.appendChild(o);});}
populate();
document.getElementById("btnCheck").onclick=()=>{
  let crop=document.getElementById("cropSelect").value;
  let r=cropDB.find(x=>x[0]==crop);
  if(r){let ok=phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4];
    document.getElementById("lblResult").innerText=ok?"‚úÖ Suitable":"‚ùå Not Suitable";}
};
document.getElementById("btnAI").onclick=()=>{
  let list=cropDB.filter(r=>phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4]);
  document.getElementById("lblResult").innerText="AI Suggests: "+list.map(x=>x[0]).join(", ");
};

/* --- Translator --- */
document.getElementById("btnTranslate").onclick=async()=>{
  let txt=document.getElementById("txtTranslate").value;
  let lang=document.getElementById("langSelect").value;
  let url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=en|${lang}`;
  let r=await fetch(url); let j=await r.json();
  document.getElementById("lblTranslation").innerText=j.responseData.translatedText;
};

/* --- Voice Assistant with AI --- */
document.getElementById("btnVoice").onclick=()=>{
  const rec=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.lang="en-US"; rec.start();
  rec.onresult=async e=>{
    let speech=e.results[0][0].transcript.toLowerCase();
    document.getElementById("lblVoice").innerText="You said: "+speech;

    if(speech.includes("forward")) callEsp("/forward");
    else if(speech.includes("stop")) callEsp("/stop");
    else if(speech.includes("soil")||speech.includes("reading")){
      let txt=await callEsp("/readSensors");
      document.getElementById("lblVoice").innerText="Soil Reading: "+txt;
    }
    else if(speech.includes("suggest crop")){
      let list=cropDB.filter(r=>phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4]);
      document.getElementById("lblVoice").innerText="AI Suggests: "+list.map(x=>x[0]).join(", ");
    }
    else if(speech.includes("translate")){
      let parts=speech.split("translate");
      if(parts[1]){
        let txt=parts[1].trim();
        let url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=en|te`;
        let r=await fetch(url); let j=await r.json();
        document.getElementById("lblVoice").innerText="Telugu: "+j.responseData.translatedText;
      }
    }
  };
};
</script>
</body>
</html>   
