<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart AgriAdvisor</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f7f7f7;margin:0;padding:0;color:#222}
  header{background:#2b6cb0;color:#fff;padding:15px;text-align:center;font-size:20px;font-weight:700}
  .container{padding:15px;max-width:720px;margin:0 auto}
  .card{background:#fff;padding:12px;margin-bottom:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
  label{display:block;margin-bottom:6px;font-weight:600}
  button{padding:10px;border:none;border-radius:6px;background:#2b6cb0;color:white;cursor:pointer;margin:5px}
  button.gray{background:#718096}
  .row{display:flex;gap:6px;flex-wrap:wrap}
  select,input{padding:8px;border:1px solid #ddd;border-radius:6px;width:100%}
  .result{margin-top:8px;color:#c53030;font-weight:700}
  pre{background:#222;color:#eee;padding:8px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
<header>Smart AgriAdvisor</header>
<div class="container">

  <!-- Connection -->
  <div class="card">
    <label>ESP32 Connection</label>
    <div class="row">
      <input id="espIp" value="192.168.4.1"/> <!-- default ESP32 AP IP -->
      <button id="btnConnect">üåê Connect WiFi</button>
      <button id="btnDisconnect" class="gray">Disconnect</button>
      <button id="btnBT">üîµ Connect Bluetooth</button>
    </div>
    <div id="status">Not Connected</div>
  </div>

  <!-- Soil Readings -->
  <div class="card">
    <label>Soil Readings</label>
    <div id="lblPH">pH: --</div>
    <div id="lblMoist">Moisture: --</div>
    <div id="lblTemp">Temp: --</div>
    <div class="row">
      <button id="btnTakeReading">Take Reading</button>
      <button id="btnRefresh" class="gray">Refresh</button>
    </div>
  </div>

  <!-- Robot Controls -->
  <div class="card">
    <label>Robot Controls</label>
    <div class="row">
      <button data-act="forward">‚¨Ü Forward</button>
      <button data-act="left">‚¨Ö Left</button>
      <button data-act="stop">üõë Stop</button>
      <button data-act="right">‚û° Right</button>
      <button data-act="backward">‚¨á Backward</button>
      <button data-act="servoDip">‚öô Dip Servo</button>
      <button data-act="servoLift">‚öô Lift Servo</button>
    </div>
  </div>

  <!-- Debug -->
  <div class="card">
    <label>Debug</label>
    <pre id="debug">No data yet</pre>
  </div>
</div>

<script>
let espUrl = "";
let connected = false;
let useBT = false;

// --- Bluetooth vars ---
let btDevice, btServer, txChar, rxChar;
const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0"; // replace with your UUID
const TX_CHAR_UUID = "12345678-1234-5678-1234-56789abcdef1"; // ESP32 Notify
const RX_CHAR_UUID = "12345678-1234-5678-1234-56789abcdef2"; // ESP32 Write

function setStatus(msg){ document.getElementById("status").innerText = msg; }

/* ---------------- WiFi ---------------- */
document.getElementById("btnConnect").onclick = ()=>{
  let ip = document.getElementById("espIp").value.trim();
  if(!ip){ alert("Enter ESP32 IP!"); return; }
  espUrl = "http://" + ip;
  connected = true; useBT = false;
  setStatus("‚úÖ WiFi Connected: " + espUrl);
};

document.getElementById("btnDisconnect").onclick = ()=>{
  connected = false; useBT = false;
  espUrl = "";
  setStatus("‚ùå Disconnected");
};

async function callEsp(path){
  if(!connected){ alert("Not connected!"); return; }
  try{
    if(useBT){
      // send command via Bluetooth
      let encoder = new TextEncoder();
      await rxChar.writeValue(encoder.encode(path));
      return "Sent via BT: " + path;
    }else{
      let res = await fetch(espUrl + path);
      let txt = await res.text();
      document.getElementById("debug").innerText = txt;
      return txt;
    }
  }catch(e){
    document.getElementById("debug").innerText = "Error: " + e;
  }
}

/* ---------------- Bluetooth ---------------- */
document.getElementById("btnBT").onclick = async()=>{
  try{
    btDevice = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:"ESP32"}],
      optionalServices:[SERVICE_UUID]
    });
    btServer = await btDevice.gatt.connect();
    let service = await btServer.getPrimaryService(SERVICE_UUID);
    txChar = await service.getCharacteristic(TX_CHAR_UUID);
    rxChar = await service.getCharacteristic(RX_CHAR_UUID);

    // enable notifications
    await txChar.startNotifications();
    txChar.addEventListener("characteristicvaluechanged", e=>{
      let val = new TextDecoder().decode(e.target.value);
      document.getElementById("debug").innerText = "BT RX: " + val;
      if(val.includes("pH")) updateSensors(val);
    });

    connected = true; useBT = true;
    setStatus("‚úÖ Bluetooth Connected to ESP32");
  }catch(e){
    setStatus("‚ùå BT Error: " + e);
  }
};

/* --- Soil Readings --- */
function updateSensors(txt){
  let nums = txt.match(/-?\d+(\.\d+)?/g);
  if(nums && nums.length>=3){
    document.getElementById("lblPH").innerText = "pH: " + nums[0];
    document.getElementById("lblMoist").innerText = "Moisture: " + nums[1] + "%";
    document.getElementById("lblTemp").innerText = "Temp: " + nums[2] + "¬∞C";
  }
}
document.getElementById("btnTakeReading").onclick = async()=>{
  let txt = await callEsp("/readSensors");
  if(txt && !useBT) updateSensors(txt);
};
document.getElementById("btnRefresh").onclick = async()=>{
  let txt = await callEsp("/readSensors");
  if(txt && !useBT) updateSensors(txt);
};

/* --- Robot Controls --- */
document.querySelectorAll("button[data-act]").forEach(btn=>{
  btn.onclick = ()=>{ callEsp("/" + btn.dataset.act); };
});
</script>
</body>
</html>
