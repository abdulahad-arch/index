<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart AgriAdvisor — Web</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f7;color:#222}
  header{background:#2b6cb0;color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:700}
  .container{padding:14px;max-width:920px;margin:12px auto}
  .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.06);margin-bottom:12px}
  label{display:block;font-weight:700;margin-bottom:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px}
  input,select,textarea{flex:1}
  button{background:#2b6cb0;color:#fff;border:none;cursor:pointer}
  button.gray{background:#718096}
  button.small{padding:6px 8px;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .stat{font-weight:700;margin-top:6px}
  .result{color:#0b6b35;font-weight:700;margin-top:8px}
  pre{background:#0f1724;color:#e6eef8;padding:10px;border-radius:6px;overflow:auto;max-height:220px}
  .small{font-size:13px;color:#666}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
<header>Smart AgriAdvisor — Web</header>
<div class="container">

  <!-- Connection -->
  <div class="card">
    <label>Connect to ESP32</label>
    <div class="row">
      <input id="espIp" value="192.168.4.1" placeholder="ESP32 IP (e.g. 192.168.4.1)"/>
      <button id="btnConnect" class="small">Connect</button>
      <button id="btnDisconnect" class="small gray">Disconnect</button>
    </div>
    <div id="connStatus" class="small muted">Status: Not connected</div>
  </div>

  <!-- Sensors + Actions -->
  <div class="card">
    <label>Soil & Environment</label>
    <div class="grid">
      <div>
        <div class="stat">pH</div>
        <div id="lblPH">--</div>
      </div>
      <div>
        <div class="stat">Moisture (%)</div>
        <div id="lblMoist">--</div>
      </div>
      <div>
        <div class="stat">Temp (°C)</div>
        <div id="lblTemp">--</div>
      </div>
      <div>
        <div class="stat">Humidity (%)</div>
        <div id="lblHum">--</div>
      </div>
      <div>
        <div class="stat">Obstacle (cm)</div>
        <div id="lblDist">--</div>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <button id="btnRead" class="small">Take Soil Reading</button>
      <button id="btnRefresh" class="small gray">Refresh</button>
      <button id="btnShowLogs" class="small gray">Show Logs</button>
    </div>
    <div id="logArea" class="small muted" style="white-space:pre-wrap;margin-top:8px"></div>
  </div>

  <!-- Crop selection & AI -->
  <div class="card">
    <label>Crop Suitability & AI Suggestion</label>
    <div class="row">
      <select id="cropSelect"></select>
      <button id="btnCheck" class="small">Check Suitability</button>
      <button id="btnAI" class="small gray">AI Suggest</button>
    </div>
    <div id="lblResult" class="result"></div>
    <div id="aiList" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- Robot controls -->
  <div class="card">
    <label>Robot Controls</label>
    <div class="row">
      <button data-cmd="forward">⬆ Forward</button>
      <button data-cmd="left">⬅ Left</button>
      <button data-cmd="stop" class="gray">🛑 Stop</button>
      <button data-cmd="right">➡ Right</button>
      <button data-cmd="backward">⬇ Backward</button>
      <button data-cmd="servoDip" class="small">⚙ Dip Servo</button>
      <button data-cmd="servoLift" class="small gray">⚙ Lift Servo</button>
    </div>
    <div id="carStatus" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- Translator -->
  <div class="card">
    <label>Translator (Hindi / Telugu)</label>
    <div class="row">
      <input id="txtTranslate" placeholder="Type English text..."/>
      <select id="langSelect" style="width:160px">
        <option value="hi">Hindi</option>
        <option value="te">Telugu</option>
      </select>
      <button id="btnTranslate" class="small">Translate</button>
    </div>
    <div id="lblTranslation" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- Weather -->
  <div class="card">
    <label>Weather Advisory</label>
    <div class="row">
      <input id="city" placeholder="City (or leave blank for local)"/>
      <button id="btnWeather" class="small">Check Weather</button>
    </div>
    <div id="lblWeather" style="margin-top:8px" class="muted"></div>
  </div>

  <!-- Profit Estimator -->
  <div class="card">
    <label>Profit Estimator</label>
    <div class="row">
      <select id="cropProfit"></select>
      <input id="yieldInput" placeholder="Yield (quintals)"/>
      <button id="btnProfit" class="small">Estimate</button>
    </div>
    <div id="lblProfit" class="result"></div>
  </div>

  <!-- Debug -->
  <div class="card">
    <label>Debug / Raw Response</label>
    <pre id="debug">No data yet</pre>
  </div>

</div>

<script>
/* ------------- Crop DB (50+ crops) -------------
  Format: [ "Name", minPH, maxPH, minMoistPercent, minTempC, pricePerQuintal ]
------------------------------------------------*/
const cropDB = [
  ["Wheat",6,7.5,40,15,2000],["Rice",5.5,7,60,20,1800],["Maize",5.5,7,50,18,1500],
  ["Cotton",6,8,50,22,5000],["Potato",5.5,7,30,15,1200],["Tomato",5.5,7,30,20,1500],
  ["Onion",6,7,35,18,1400],["Sugarcane",6,8,60,21,3000],["Soybean",6,7.5,40,20,2500],
  ["Peanut",5.5,7,35,22,3000],["Sunflower",6,7.5,30,18,3200],["Barley",6,7.5,35,15,1600],
  ["Oats",5,7.5,35,15,1800],["Millet",5,7.5,30,20,1400],["Sorghum",5.5,7.5,35,22,1600],
  ["Chickpea",6,8,30,18,4000],["Lentil",6,8,30,16,4500],["Pea",6,7.5,35,15,2800],
  ["Mustard",5.5,7.5,30,18,5000],["Groundnut",5.5,7.5,35,22,3500],["Sesame",5.5,7.5,30,20,6000],
  ["Castor",5.5,7.5,30,20,4000],["Jute",6,7.5,50,20,2500],["Tea",4.5,6,60,18,12000],
  ["Coffee",5,6.5,60,20,15000],["Banana",5.5,7.5,50,22,1000],["Mango",5.5,7.5,30,25,3000],
  ["Apple",6,7,40,15,5000],["Orange",5.5,6.5,40,20,4000],["Grapes",6,7.5,35,20,4500],
  ["Papaya",6,7.5,40,22,2000],["Guava",5,7.5,35,20,2500],["Pineapple",4.5,6.5,50,22,3000],
  ["Pomegranate",5.5,7.5,35,20,5000],["Cabbage",6,7.5,40,15,1200],["Cauliflower",6,7.5,40,15,1400],
  ["Carrot",6,7,35,15,2000],["Spinach",6,7.5,35,15,1000],["Cucumber",5.5,7.5,40,18,1500],
  ["Chilli",5.5,7.5,40,20,6000],["Brinjal",5.5,7.5,40,20,2000],["Okra",6,7.5,40,20,2500],
  ["Pumpkin",6,7.5,40,18,1500],["Melon",5.5,7.5,35,20,2000],["Watermelon",5.5,7.5,35,22,1800],
  ["Strawberry",5.5,7,40,18,8000],["Pear",6,7,35,15,3500],["Plum",6,7.5,35,15,3000]
];

/* ------------- App state ------------- */
let espUrl = "";
let connected = false;
let phVal = null, moistVal = null, tempVal = null, humVal = null, distVal = null;

/* init crop selects */
function populateCrops(){
  const sel = document.getElementById('cropSelect');
  const sel2 = document.getElementById('cropProfit');
  sel.innerHTML = '';
  sel2.innerHTML = '';
  cropDB.forEach(r=>{
    const o = document.createElement('option');
    o.value = r[0]; o.text = r[0];
    sel.appendChild(o);
    const o2 = document.createElement('option');
    o2.value = r[0]; o2.text = r[0];
    sel2.appendChild(o2);
  });
}
populateCrops();

/* ------------- Helpers ------------- */
function setConnStatus(txt){
  document.getElementById('connStatus').innerText = 'Status: ' + txt;
}
function setDebug(txt){
  document.getElementById('debug').innerText = txt;
}

/* ------------- Connect / Disconnect ------------- */
document.getElementById('btnConnect').onclick = async () => {
  const ip = document.getElementById('espIp').value.trim();
  if(!ip){ alert('Enter ESP32 IP'); return; }
  espUrl = (ip.startsWith('http')? ip : ('http://'+ip));
  try {
    const r = await fetch(espUrl + '/');
    const text = await r.text();
    setDebug(text);
    connected = true;
    setConnStatus('Connected to ' + espUrl);
    alert('✅ Connected to ESP32');
  } catch(e){
    connected = false;
    setConnStatus('Failed to connect');
    setDebug('Error: ' + e);
    alert('❌ Unable to connect to ESP32. Make sure your phone is connected to ESP32 Wi-Fi (or same router).');
  }
};

document.getElementById('btnDisconnect').onclick = () => {
  connected = false;
  espUrl = '';
  setConnStatus('Disconnected');
  setDebug('Disconnected');
};

/* ------------- Read Sensors ------------- */
async function fetchSensors(){
  if(!connected){ alert('Connect to ESP32 first'); return; }
  try{
    const r = await fetch(espUrl + '/readSensors');
    const text = await r.text();
    setDebug(text);
    // server sends JSON in your sketch, attempt parse
    try {
      const j = JSON.parse(text);
      phVal = parseFloat(j.pH); moistVal = parseFloat(j.Moist); tempVal = parseFloat(j.Temp); humVal = parseFloat(j.Hum); distVal = parseFloat(j.DistanceCM);
    } catch(err){
      // try to parse numbers from free text format "pH:6.5, Moist:45.0, Temp:28.3"
      const nums = text.match(/-?\d+(\.\d+)?/g);
      if(nums && nums.length>=3){
        phVal = parseFloat(nums[0]); moistVal = parseFloat(nums[1]); tempVal = parseFloat(nums[2]);
        // humidity/distance may not be present in older endpoint
        humVal = nums[3]?parseFloat(nums[3]):humVal;
        distVal = nums[4]?parseFloat(nums[4]):distVal;
      } else {
        throw new Error('No numeric data found');
      }
    }

    // update UI
    document.getElementById('lblPH').innerText = phVal!==null? phVal : '--';
    document.getElementById('lblMoist').innerText = moistVal!==null? moistVal+' %' : '--';
    document.getElementById('lblTemp').innerText = tempVal!==null? tempVal + ' °C' : '--';
    document.getElementById('lblHum').innerText = humVal!==null? humVal+' %' : '--';
    document.getElementById('lblDist').innerText = distVal!==null? distVal + ' cm' : '--';

    // save log
    let logs = JSON.parse(localStorage.getItem('soilLogs')||'[]');
    logs.push({time:new Date().toLocaleString(), pH:phVal, moist:moistVal, temp:tempVal, hum:humVal, dist:distVal});
    if(logs.length>20) logs = logs.slice(-20);
    localStorage.setItem('soilLogs', JSON.stringify(logs));
    document.getElementById('logArea').innerText = 'Last 3 logs:\n' + logs.slice(-3).map(l=>`${l.time} → pH:${l.pH}, M:${l.moist}, T:${l.temp}, D:${l.dist}`).join('\n');

    return true;
  }catch(e){
    setDebug('ReadSensors error: ' + e);
    alert('Error reading sensors. See debug.');
    return false;
  }
}
document.getElementById('btnRead').onclick = fetchSensors;
document.getElementById('btnRefresh').onclick = fetchSensors;
document.getElementById('btnShowLogs').onclick = ()=> {
  const logs = JSON.parse(localStorage.getItem('soilLogs')||'[]');
  alert('Saved logs (last 10):\n' + logs.slice(-10).map(l=>`${l.time} → pH:${l.pH}, M:${l.moist}, T:${l.temp}, D:${l.dist}`).join('\n'));
};

/* ------------- Crop checks & AI ------------- */
document.getElementById('btnCheck').onclick = ()=>{
  const cropName = document.getElementById('cropSelect').value;
  const r = cropDB.find(x=>x[0]===cropName);
  if(!r){ alert('Select a crop'); return; }
  if(phVal===null){ alert('Read sensors first'); return; }
  const okPH = phVal >= r[1] && phVal <= r[2];
  const okMoist = moistVal >= r[3];
  const okTemp = tempVal >= r[4];
  const ok = okPH && okMoist && okTemp;
  document.getElementById('lblResult').innerText = ok? `✅ ${cropName} is suitable` : `❌ ${cropName} NOT suitable (see AI suggestions)`;
};

document.getElementById('btnAI').onclick = ()=>{
  if(phVal===null){ alert('Read sensors first'); return; }
  const matches = cropDB.filter(r=>{
    return phVal >= r[1] && phVal <= r[2] && moistVal >= r[3] && tempVal >= r[4];
  }).map(r=>r[0]);
  document.getElementById('aiList').innerText = matches.length? 'AI Suggests: '+matches.join(', ') : 'No suitable crops found';
  document.getElementById('lblResult').innerText = '';
};

/* ------------- Robot controls ------------- */
async function sendCar(cmd){
  if(!connected){ alert('Connect to ESP32 first'); return; }
  try {
    // your ESP32 sketch uses /car?cmd=...
    const r = await fetch(espUrl + '/car?cmd=' + encodeURIComponent(cmd));
    const text = await r.text();
    setDebug(text);
    document.getElementById('carStatus').innerText = 'Last: ' + cmd + ' → ' + text;
    // if obstacle message returned, also update UI
    if(text && text.toLowerCase().includes('obstacle')) {
      alert('⚠ Obstacle detected by ESP32 — motors stopped');
    }
  } catch(e) {
    setDebug('Car command error: '+e);
    alert('Error sending car command');
  }
}

document.querySelectorAll('button[data-cmd]').forEach(b=>{
  b.onclick = ()=> sendCar(b.getAttribute('data-cmd'));
});

/* ------------- Translator (MyMemory) ------------- */
document.getElementById('btnTranslate').onclick = async ()=>{
  const txt = document.getElementById('txtTranslate').value.trim();
  if(!txt){ alert('Enter text to translate'); return; }
  const lang = document.getElementById('langSelect').value || 'hi';
  try{
    const res = await fetch('https://api.mymemory.translated.net/get?q='+encodeURIComponent(txt)+'&langpair=en|'+lang);
    const j = await res.json();
    document.getElementById('lblTranslation').innerText = j.responseData.translatedText;
  }catch(e){
    document.getElementById('lblTranslation').innerText = 'Translate error: '+e;
  }
};

/* ------------- Weather advice (wttr.in) ------------- */
document.getElementById('btnWeather').onclick = async ()=>{
  const city = document.getElementById('city').value.trim() || '';
  try{
    // wttr.in simple text response
    const res = await fetch('https://wttr.in/' + encodeURIComponent(city) + '?format=%t+%h+%w');
    const txt = await res.text();
    document.getElementById('lblWeather').innerText = 'Weather: ' + txt + '\nAdvice: ' + (getWeatherAdvice(txt));
  }catch(e){
    document.getElementById('lblWeather').innerText = 'Weather error: ' + e;
  }
};
function getWeatherAdvice(txt){
  // txt format like "+29°C 74% ...", approximate rules
  const nums = txt.match(/-?\d+%?/g) || [];
  // simple fallback advice
  if(!nums || nums.length===0) return 'No data';
  // try humidity
  const humMatch = txt.match(/(\d{1,3})%/);
  const hum = humMatch? parseInt(humMatch[1]) : null;
  if(hum !== null){
    if(hum < 40) return 'Low humidity — irrigate soon';
    if(hum < 70) return 'Normal humidity — regular schedule';
    return 'High humidity — reduce irrigation';
  }
  return 'No specific advice';
}

/* ------------- Profit Estimator ------------- */
document.getElementById('btnProfit').onclick = ()=>{
  const cropName = document.getElementById('cropProfit').value;
  const y = parseFloat(document.getElementById('yieldInput').value || '0');
  if(!cropName || y<=0){ alert('Select crop and enter yield'); return; }
  const r = cropDB.find(x=>x[0]===cropName);
  if(!r){ alert('Crop not found'); return; }
  const price = r[5]; // price per quintal
  const profit = y * price;
  document.getElementById('lblProfit').innerText = `Estimated revenue for ${y} q: ₹${profit.toLocaleString()}`;
};

/* ------------- Init UI ------------- */
setConnStatus('Not connected — connect to ESP32 Wi-Fi (or same router) then press Connect');
setDebug('Ready. Default ESP IP: 192.168.4.1');
</script>
</body>
</html>
